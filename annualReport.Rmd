---
title: "Annual Report"
author: "Sam Graf"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE, echo = FALSE}
library(tidyverse) 
library(lubridate)
library(DT)
library(plotly)
options(dplyr.summarise.inform = FALSE)
if(!exists("combinedData_df_list")){
  combinedData_df_list <- readRDS("data/flatFilesforApp/combinedData_df_list.rds")
}
if(!exists("indiv_datasets_list")){
  indiv_datasets_list <- readRDS("data/flatFilesforApp/indiv_datasets_list.rds")
}
if(!exists("Enc_release_data")){
  Enc_release_data <- readRDS("data/flatFilesforApp/Enc_release_data.rds")
}
if(!exists("encounterMARKStates")){
  encounterMARKStates <- readRDS("data/flatFilesforApp/encounterMARKStates.rds")
}
if(!exists("movements_list")){
  movements_list <- readRDS("data/flatFilesforApp/movements_list.rds")
}
if(!exists("unknown_tags")){
  unknown_tags <- readRDS("data/flatFilesforApp/unknown_tags.rds")
}

if(!exists("avianPredationList")){
  avianPredationList <- readRDS("data/flatFilesforApp/possibleAvianPredationDFs.rds")
}

if(!exists("wgfpMetadata")){
  wgfpMetadata <- readRDS("data/flatFilesforApp/wgfpMetadata.rds")
}

if(!exists("metaDataVariableNames")){
  metaDataVariableNames <- readRDS("data/flatFilesforApp/metaDataVariableNames.rds")
}

if(!exists("PTData")){
  PTData <- readRDS("data/flatFilesforApp/PTData.rds")
}

if(!exists("USGSData")){
  USGSData <- readRDS("data/flatFilesforApp/USGSData.rds")
}

if(!exists("SiteVisitData")){
  SiteVisitData <- readRDS("data/flatFilesforApp/SiteVisitData.rds")
}

rainbow_trout_colors <- c("#8B8000", "#008080", "#FF69B4", "#FF4500", "#6A5ACD","#32CD32", "#20B2AA",
                          "#FF1C55", "#4682B4", "#556B2F", "#DC143C", "#B22222", "#7FFF00", "#8A2BE2", "#00CED1")
#currently "Changed Rivers", "Downstream Movement" "Initial Release", "No Movement", "Upstream Movement" (5/17/24)
#note: these are a little diffeerent than what we see in the map because the map/marker color optoins are very limited. 
movementColorsValues <- c("purple", "#eb0e2b", "#FF8C00", "gray", "#22bd74") #, "#66FF00"
# currently "BRK" "LOC" "MERG" "MTS" "RBT" "RXN" "TGM" (5/17/24)
speciesColors <- c("#FFD700", "#654321", "#4F7942", "#FF7F50", "#1E90FF", "#008080", "#DAA520", "#D2691E", "#9A5ECD") 

#maybe a better method for this, but pressure transducer site names are changed to the same names as Site Visit site names
#and that variable is what we use to assign colors to sites   
allSites <- metaDataVariableNames$allDetectionDistanceSiteNames
movementColors <- setNames(movementColorsValues, sort(unique(movements_list$Movements_df$movement_only)))
siteColors <- setNames(rainbow_trout_colors[0:length(allSites)], allSites)
speciesColors <- setNames(speciesColors[0:length(unique(indiv_datasets_list$releasedata$Species))], sort(unique(indiv_datasets_list$releasedata$Species)))
 
allColors <- c(movementColors, siteColors, speciesColors)

```

## Tagging Summary
### All Data Excludes TGM

```{r, echo = FALSE, include=TRUE}
ReleaseData <- indiv_datasets_list$releasedata %>%
  mutate(Date = as.Date(Date)) %>%
  filter(!Species %in% c("TGM"))
Recaptures <- indiv_datasets_list$recapdata %>%
  mutate(Date = as.Date(Date))

releaseRecaps <- Recaptures %>%
  rename(ReleaseSite = RecaptureSite) %>%
  bind_rows(ReleaseData) %>%
  rename(Site = ReleaseSite) %>%
  count(Event, Year = year(Date), Species)

datatable(releaseRecaps, 
          caption = "Release/Recapture Summaries, No TGM",
  options = list(
    pageLength = 10,
    autoWidth = TRUE
  ),
  filter = list(
  position = 'top', clear = FALSE
),
  rownames = FALSE
  )
# number of fish tagged 
ReleaseData %>%
          ggplot(aes(x = Length, fill = Species) ) +
          geom_histogram(binwidth = 20)+
          theme_classic() +
          labs(title = "Released Fish by Length", caption = "Binwidth = 20mm") +
          scale_fill_manual(values = allColors) +
          facet_wrap(~year(Date))
# percentage fish released, how many were TLNT, vs recap vs straigght release, by species  
# table 
ReleaseCounts <- ReleaseData %>%
  count(Year = year(Date), ReleaseSite, Species, Event) 

datatable(ReleaseCounts, 
          caption = "Release Summaries",
  options = list(
    pageLength = 10,
    autoWidth = TRUE
  ),
  filter = list(
  position = 'top', clear = FALSE
),
  rownames = FALSE
  )
# number recaptured, how many were TLNT (Recapped and Release)
RecaptureCounts <- Recaptures %>%
  count(Year = year(Date), RecaptureSite, Species) 

datatable(RecaptureCounts, 
          caption = "Recapture Summaries",
  options = list(
    pageLength = 10,
    autoWidth = TRUE
  ),
  filter = list(
  position = 'top', clear = FALSE
),
  rownames = FALSE
  ) #%>%
  #formatPercentage(c("DS Percentage"), 2)
#Length and Weight Range
#range(ReleaseData$)
LWRanges <- ReleaseData %>%
  group_by(Year = year(Date), Species) %>%
  summarise(`Minimum Length (mm)` = round(min(Length, na.rm = T), 2), 
            `Maximum Length (mm)` = round(max(Length, na.rm = T), 2),
            `Average Length (mm)` = round(mean(Length, na.rm = T), 2),
            `Minimum Weight (g)` = round(min(Weight, na.rm = T), 2), 
            `Maximum Weight (g)` = round(max(Weight, na.rm = T), 2),
            `Average Weight (g)` = round(mean(Weight, na.rm = T), 2))

datatable(LWRanges, 
          caption = "Length and Weight Summaries",
  options = list(
    pageLength = 10,
    autoWidth = TRUE
  ),
  filter = list(
  position = 'top', clear = FALSE
),
  rownames = FALSE
  )

```
## Movement Summary
### TGMS and mobile runs excluded
```{r, include=TRUE, echo=FALSE}
movementsData <- movements_list$Movements_df %>%
  filter(!Species %in% c("TGM"), 
         !det_type %in% c("Mobile Run")
         )
# how many swam through channel?

#Annual Figure of Upstream vs downstream movements
seasonal_movts <- movementsData %>%
  filter(!movement_only %in% c("Initial Release")) %>%
  group_by(Month = lubridate::month(Date), Day = day(Date), movement_only) %>%
  summarise(total_events = n())

plot <- seasonal_movts %>%
            mutate(merged = (parse_date_time(paste(Month, Day), "md"))) %>%
            ggplot(aes(x = merged, y = total_events, fill = movement_only)) +
            geom_bar(stat = "identity", position = "dodge") +
            theme_classic() +
            labs(title = "Seasonal Daily Movements", x = "Day", y = "Counts",
                 caption = "Currently No download option for this data.") +
            scale_x_datetime(date_labels = "%b") +
            scale_fill_manual(values = allColors)
          
ggplotly(plot)

datatable(
    seasonal_movts,
    caption = "Releases and Mobile Runs not included", 
    rownames = FALSE,
    selection = "single",
    filter = 'top',
    options = list(
      stateSave = TRUE,
      pageLength = 10,
      info = TRUE,
      lengthMenu = list(c(10, 25, 50, 100, 200), c("10", "25", "50", "100", "200")),
      dom = 'lfrtip'
    )
  )
          
          

#movements by size/age class
movementsLength <- movementsData %>%
  mutate(length_bin = cut(
    Release_Length,
    breaks = c(0, 100, 200, 300, 400, 500, Inf),
    labels = c("0-100", "100-200", "200-300", "300-400", "400-500", "500+"),
    right = FALSE
))

movementsLengths <- movementsLength %>%
  count(length_bin, movement_only) %>%
  arrange(length_bin, movement_only) 

movementsLengthsWide <- movementsLengths %>%
  pivot_wider(names_from = movement_only, values_from = n) %>%
  mutate(`DS Percentage` = `Downstream Movement`/(`Upstream Movement` + `Downstream Movement`))

datatable(movementsLengthsWide, 
          caption = "Movement Summary Table by Length Bins",
  options = list(
    pageLength = 10,
    autoWidth = TRUE
  ),
  filter = list(
  position = 'top', clear = FALSE
),
  rownames = FALSE
  ) %>%
  formatPercentage(c("DS Percentage"), 2)

plot <- ggplot(movementsLengths, aes(x = length_bin, y = n, fill = movement_only)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    x = "Length Bin (mm)",
    y = "Count of Movements",
    fill = "Movement Type",
    title = "Distribution of Movement Types Across Length Bins"
  ) +
  theme_minimal() +
  scale_fill_manual(
    values = c(
      "Changed Rivers"        = "purple",
      "Downstream Movement"   = "#eb0e2b",
      "No Movement"           = "gray",
      "Upstream Movement"     = "#22bd74"
    )
  ) +
  #facet_wrap(~Species, ncol = 2) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

ggplotly(plot)

```

## Antenna data
```{r}
# number of days the antennas were down

# how many fish were seen on each antenna

# number of detections by year by antenna; 

# by type; total detections on stationary vs biomark vs mobile vs recaps

#unique detectyions; are we getting tags with these other methods that we don't see on stationary or other types?
```

## Before and After
```{r}
#movements from HP to CF before construction of channel vs after channel
#compare with movements from Red Barn to Hitching Post 
```


## Avian Predation
```{r}
# movement of fish vs avian predated/Known Merg
```

