---
title: "Annual Report"
author: "Sam Graf"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE, echo = FALSE}
library(tidyverse) 
library(lubridate)
library(DT)
library(plotly)
options(dplyr.summarise.inform = FALSE)
if(!exists("combinedData_df_list")){
  combinedData_df_list <- readRDS("data/flatFilesforApp/combinedData_df_list.rds")
}
if(!exists("indiv_datasets_list")){
  indiv_datasets_list <- readRDS("data/flatFilesforApp/indiv_datasets_list.rds")
}
if(!exists("Enc_release_data")){
  Enc_release_data <- readRDS("data/flatFilesforApp/Enc_release_data.rds")
}
if(!exists("encounterMARKStates")){
  encounterMARKStates <- readRDS("data/flatFilesforApp/encounterMARKStates.rds")
}
if(!exists("movements_list")){
  movements_list <- readRDS("data/flatFilesforApp/movements_list.rds")
}
if(!exists("unknown_tags")){
  unknown_tags <- readRDS("data/flatFilesforApp/unknown_tags.rds")
}

if(!exists("avianPredationList")){
  avianPredationList <- readRDS("data/flatFilesforApp/possibleAvianPredationDFs.rds")
}

if(!exists("wgfpMetadata")){
  wgfpMetadata <- readRDS("data/flatFilesforApp/wgfpMetadata.rds")
}

if(!exists("metaDataVariableNames")){
  metaDataVariableNames <- readRDS("data/flatFilesforApp/metaDataVariableNames.rds")
}

if(!exists("PTData")){
  PTData <- readRDS("data/flatFilesforApp/PTData.rds")
}

if(!exists("USGSData")){
  USGSData <- readRDS("data/flatFilesforApp/USGSData.rds")
}

if(!exists("SiteVisitData")){
  SiteVisitData <- readRDS("data/flatFilesforApp/SiteVisitData.rds")
}

rainbow_trout_colors <- c("#8B8000", "#008080", "#FF69B4", "#FF4500", "#6A5ACD","#32CD32", "#20B2AA",
                          "#FF1C55", "#4682B4", "#556B2F", "#DC143C", "#B22222", "#7FFF00", "#8A2BE2", "#00CED1")
#currently "Changed Rivers", "Downstream Movement" "Initial Release", "No Movement", "Upstream Movement" (5/17/24)
#note: these are a little diffeerent than what we see in the map because the map/marker color optoins are very limited. 
movementColorsValues <- c("purple", "#eb0e2b", "#FF8C00", "gray", "#22bd74") #, "#66FF00"
# currently "BRK" "LOC" "MERG" "MTS" "RBT" "RXN" "TGM" (5/17/24)
speciesColors <- c("#FFD700", "#654321", "#4F7942", "#FF7F50", "#1E90FF", "#008080", "#DAA520", "#D2691E", "#9A5ECD") 

#maybe a better method for this, but pressure transducer site names are changed to the same names as Site Visit site names
#and that variable is what we use to assign colors to sites   
allSites <- metaDataVariableNames$allDetectionDistanceSiteNames
movementColors <- setNames(movementColorsValues, sort(unique(movements_list$Movements_df$movement_only)))
siteColors <- setNames(rainbow_trout_colors[0:length(allSites)], allSites)
speciesColors <- setNames(speciesColors[0:length(unique(indiv_datasets_list$releasedata$Species))], sort(unique(indiv_datasets_list$releasedata$Species)))
 
allColors <- c(movementColors, siteColors, speciesColors)

biomarkAntennas <- str_subset(wgfpMetadata$AntennaMetadata$SiteName, "Biomark")
biomarkAntennasFrontends <- wgfpMetadata$AntennaMetadata[wgfpMetadata$AntennaMetadata$SiteName %in% biomarkAntennas, "FrontendSiteCode"]

StationaryAntennas <- str_subset(wgfpMetadata$AntennaMetadata$SiteName, "Stationary")
StationaryAntennasFrontends <- wgfpMetadata$AntennaMetadata[wgfpMetadata$AntennaMetadata$SiteName %in% StationaryAntennas, "FrontendSiteCode"]

```

## Tagging Summary
### All Data Excludes TGM

```{r, echo = FALSE, include=TRUE}
ReleaseData <- indiv_datasets_list$releasedata %>%
  mutate(Date = as.Date(Date)) %>%
  filter(!Species %in% c("TGM"))
Recaptures <- indiv_datasets_list$recapdata %>%
  mutate(Date = as.Date(Date))

releaseRecaps <- Recaptures %>%
  rename(ReleaseSite = RecaptureSite) %>%
  bind_rows(ReleaseData) %>%
  rename(Site = ReleaseSite) %>%
  count(Event, Year = year(Date), Species)

datatable(releaseRecaps, 
          caption = "Release/Recapture Summaries, No TGM",
  options = list(
    pageLength = 10,
    autoWidth = TRUE
  ),
  filter = list(
  position = 'top', clear = FALSE
),
  rownames = FALSE
  )
# number of fish tagged 
ReleaseData %>%
          ggplot(aes(x = Length, fill = Species) ) +
          geom_histogram(binwidth = 20)+
          theme_classic() +
          labs(title = "Released Fish by Length", caption = "Binwidth = 20mm") +
          scale_fill_manual(values = allColors) +
          facet_wrap(~year(Date))
# percentage fish released, how many were TLNT, vs recap vs straigght release, by species  
# table 
ReleaseCounts <- ReleaseData %>%
  count(Year = year(Date), ReleaseSite, Species, Event) 

datatable(ReleaseCounts, 
          caption = "Release Summaries",
  options = list(
    pageLength = 10,
    autoWidth = TRUE
  ),
  filter = list(
  position = 'top', clear = FALSE
),
  rownames = FALSE
  )
# number recaptured, how many were TLNT (Recapped and Release)
RecaptureCounts <- Recaptures %>%
  count(Year = year(Date), RecaptureSite, Species) 

datatable(RecaptureCounts, 
          caption = "Recapture Summaries",
  options = list(
    pageLength = 10,
    autoWidth = TRUE
  ),
  filter = list(
  position = 'top', clear = FALSE
),
  rownames = FALSE
  ) #%>%
  #formatPercentage(c("DS Percentage"), 2)
#Length and Weight Range
#range(ReleaseData$)
LWRanges <- ReleaseData %>%
  group_by(Year = year(Date), Species) %>%
  summarise(`Minimum Length (mm)` = round(min(Length, na.rm = T), 2), 
            `Maximum Length (mm)` = round(max(Length, na.rm = T), 2),
            `Average Length (mm)` = round(mean(Length, na.rm = T), 2),
            `Minimum Weight (g)` = round(min(Weight, na.rm = T), 2), 
            `Maximum Weight (g)` = round(max(Weight, na.rm = T), 2),
            `Average Weight (g)` = round(mean(Weight, na.rm = T), 2))

datatable(LWRanges, 
          caption = "Length and Weight Summaries",
  options = list(
    pageLength = 10,
    autoWidth = TRUE
  ),
  filter = list(
  position = 'top', clear = FALSE
),
  rownames = FALSE
  )

```
## Movement Summary

```{r, include=TRUE, echo=FALSE}
movementsData <- movements_list$Movements_df %>%
  filter(!Species %in% c("TGM"), 
         !det_type %in% c("Mobile Run")
         )
# how many swam through channel?
#these are all based off states created in createMARKhistoriesFunction()
Enc_release_data1 <- Enc_release_data %>%
  mutate(`Length Bin` = cut(
    Length,
    breaks = c(0, 100, 200, 300, 400, 500, Inf),
    labels = c("0-100", "100-200", "200-300", "300-400", "400-500", "500+"),
    right = FALSE
))
#can use the wide summaries definition: basically how many fish were detected in state "D" (connectivity channel)
# or we could use the sequences definition and make US and DS sequences of WG2/1/HP to CF with CRCC antennas in the middle
#fish that have been detected in the channel (aka state D)
#this includes fish that were shocked and released in the channel

usedChannel <-  Enc_release_data1 %>%
  filter(channelSummary == "Used Connectivity Channel") 
#went below the dam through channel
dsChannelUsage <- Enc_release_data1 %>%
  filter(went_below_dam_throughChannel == TRUE)
#upstream channel usage
usChannelUsage <- Enc_release_data1 %>%
  filter(went_above_dam_throughChannel == TRUE)

#make these into tables by species and size
usedChannelSummarizedTotal <- usedChannel %>%
  summarise(`Total Fish Detected In Channel` = n())
dsChannelUsageSummarizedTotal <- dsChannelUsage %>%
  summarise(`Total Fish Swam Downstream Through Channel` = n())
usChannelUsageSummarizedTotal <- usChannelUsage %>%
  summarise(`Total Fish Swam Upstream Through Channel` = n())

totalFishChannelTable <- bind_cols(list(usedChannelSummarizedTotal, dsChannelUsageSummarizedTotal, usChannelUsageSummarizedTotal))
datatable(
    totalFishChannelTable,
    caption = "CRCC Usage, Total Fish", 
    rownames = FALSE,
    selection = "single",
    options = list(
      stateSave = TRUE,
      pageLength = 10,
      info = TRUE
    )
  )

#by species 
#make these into tables by species and size
usedChannelSummarizedSpecies <- usedChannel %>%
  group_by(Species) %>%
  summarise(`Total Fish Detected In Channel` = n())
dsChannelUsageSummarizedSpecies <- dsChannelUsage %>%
  group_by(Species) %>%
  summarise(`Total Fish Swam Downstream Through Channel` = n())
usChannelUsageSummarizedSpecies <- usChannelUsage %>%
  group_by(Species) %>%
  summarise(`Total Fish Swam Upstream Through Channel` = n())

#missing rows, so do a full_join instead of bindig cols

speciesChannelTable <- usedChannelSummarizedSpecies %>%
  full_join(dsChannelUsageSummarizedSpecies, by = "Species") %>%
  full_join(usChannelUsageSummarizedSpecies, by = "Species")

speciesChannelTable[is.na(speciesChannelTable)] <- 0

datatable(
    speciesChannelTable,
    caption = "CRCC Usage by Species", 
    rownames = FALSE,
    selection = "single",
    options = list(
      stateSave = TRUE,
      pageLength = 10,
      info = TRUE
    )
  )
#by length 
usedChannelSummarizedLength <- usedChannel %>%
  count(`Length Bin`, name = "Total Fish Detected In Channel") %>%
  arrange(`Length Bin`)
  
dsChannelUsageSummarizedLength <- dsChannelUsage %>%
  count(`Length Bin`, name = "Total Fish Swam Downstream Through Channel") %>%
  arrange(`Length Bin`)
usChannelUsageSummarizedLength <- usChannelUsage %>%
  count(`Length Bin`, name = "Total Fish Swam Upstream Through Channel") %>%
  arrange(`Length Bin`)

lengthChannelTable <- usedChannelSummarizedLength %>%
  full_join(dsChannelUsageSummarizedLength, by = "Length Bin") %>%
  full_join(usChannelUsageSummarizedLength, by = "Length Bin")

lengthChannelTable[is.na(lengthChannelTable)] <- 0

datatable(
    lengthChannelTable,
    caption = "CRCC Usage by Length", 
    rownames = FALSE,
    selection = "single",
    options = list(
      stateSave = TRUE,
      pageLength = 10,
      info = TRUE
    )
  )
#Annual Figure of Upstream vs downstream movements
seasonal_movts <- movementsData %>%
  filter(!movement_only %in% c("Initial Release")) %>%
  group_by(Month = lubridate::month(Date), Day = day(Date), movement_only) %>%
  summarise(total_events = n())

plot <- seasonal_movts %>%
            mutate(merged = (parse_date_time(paste(Month, Day), "md"))) %>%
            ggplot(aes(x = merged, y = total_events, fill = movement_only)) +
            geom_bar(stat = "identity", position = "dodge") +
            theme_classic() +
            labs(title = "Seasonal Daily Movements", x = "Day", y = "Counts",
                 caption = "Currently No download option for this data.") +
            scale_x_datetime(date_labels = "%b") +
            scale_fill_manual(values = allColors)
          
ggplotly(plot)

datatable(
    seasonal_movts,
    caption = "Releases and Mobile Runs not included", 
    rownames = FALSE,
    selection = "single",
    filter = 'top',
    options = list(
      stateSave = TRUE,
      pageLength = 10,
      info = TRUE,
      lengthMenu = list(c(10, 25, 50, 100, 200), c("10", "25", "50", "100", "200")),
      dom = 'lfrtip'
    )
  )
          
          

#movements by size/age class
movementsLength <- movementsData %>%
  mutate(`Length Bin` = cut(
    Release_Length,
    breaks = c(0, 100, 200, 300, 400, 500, Inf),
    labels = c("0-100", "100-200", "200-300", "300-400", "400-500", "500+"),
    right = FALSE
))

movementsLengths <- movementsLength %>%
  count(`Length Bin`, movement_only) %>%
  arrange(`Length Bin`, movement_only) 

movementsLengthsWide <- movementsLengths %>%
  pivot_wider(names_from = movement_only, values_from = n) %>%
  mutate(`DS Percentage` = `Downstream Movement`/(`Upstream Movement` + `Downstream Movement`))

datatable(movementsLengthsWide, 
          caption = "Movement Summary Table by Length Bins",
  options = list(
    pageLength = 10,
    autoWidth = TRUE
  ),
  filter = list(
  position = 'top', clear = FALSE
),
  rownames = FALSE
  ) %>%
  formatPercentage(c("DS Percentage"), 2)

plot <- ggplot(movementsLengths, aes(x = `Length Bin`, y = n, fill = movement_only)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    x = "Length Bin (mm)",
    y = "Count of Movements",
    fill = "Movement Type",
    title = "Distribution of Movement Types Across Length Bins"
  ) +
  theme_minimal() +
  scale_fill_manual(
    values = c(
      "Changed Rivers"        = "purple",
      "Downstream Movement"   = "#eb0e2b",
      "No Movement"           = "gray",
      "Upstream Movement"     = "#22bd74"
    )
  ) +
  #facet_wrap(~Species, ncol = 2) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

ggplotly(plot)

```

## Antenna data
```{r, include=TRUE, echo=FALSE}
# number of days the antennas were down across all antennas
antennasDown <- wgfpMetadata$MarkerTagIssues %>%
  filter(wholeAntennaDown_nofishDetections == "yes") %>%
  mutate(timeDif = difftime(IssueEndDatetime, IssueStartDatetime, units = "days")) 
##start with stationary antennas
stationaryAntennasDown <- antennasDown %>%
  #mutate(Site = trimws(Site)) %>%
  filter(Site %in% StationaryAntennasFrontends$FrontendSiteCode) %>%
  summarise(`Total Time Antennas were down` = sum(timeDif))
#c("G1", "M1", "M2", "B5", biomarkAntennasFrontends$FrontendSiteCode)
stationaryAntennaTimeGrouped <- combinedData_df_list$All_Detections %>%
  #take out mobile and ghost backpack detections and dummy tag and biomark detections (we'll get them later)
  filter(Site_Code %in% StationaryAntennasFrontends$FrontendSiteCode) %>%
  group_by(Site_Code) %>%
  summarise(`Total Duration` = difftime(max(Scan_DateTime), min(Scan_DateTime), units = "days")) %>%
  ungroup()
StationaryAntennaTimeTotal <- stationaryAntennaTimeGrouped %>%
  summarise(`Total Duration` = sum(`Total Duration`))

totalDowntimePercentage = round((as.numeric(stationaryAntennasDown$`Total Time Antennas were down`) / as.numeric(StationaryAntennaTimeTotal$`Total Duration`)) * 100, 2)

stationaryAntennaTimeSummaryMessage <- paste0("Stationary Antennas were down for ", totalDowntimePercentage, "% of the total time across all Stationary Antennas. Inidividual Antennas were down for a total of ", round(stationaryAntennasDown$`Total Time Antennas were down`, 2), " days out of a total of ", round(StationaryAntennaTimeTotal$`Total Duration`, 2), " days of total time across all Stationary Antennas.")
# how many fish were seen on each antenna

# number of detections by year by antenna; 

# by type; total detections on stationary vs biomark vs mobile vs recaps

#unique detectyions; are we getting tags with these other methods that we don't see on stationary or other types?
```
#### `r stationaryAntennaTimeSummaryMessage`
## Before and After
```{r}
#movements from HP to CF before construction of channel vs after channel
#compare with movements from Red Barn to Hitching Post 
```


## Avian Predation
```{r}
# movement of fish vs avian predated/Known Merg
```

